<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <title>AR Interaction Lab — Story Capybara</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <!-- AR.js (A-Frame NFT support) -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.min.js"></script>

  <style>
    body { margin:0; overflow:hidden; font-family:system-ui,Segoe UI,Roboto,sans-serif }
    .info {
      position: absolute; left: 12px; top: 12px; z-index: 20;
      background: rgba(255,255,255,0.9); padding:8px 12px; border-radius:8px; font-weight:600;
    }
  </style>
</head>
<body>
  <div class="info">Scan markers in order: <strong>Jungle → Desk → Picnic</strong></div>

  <a-scene
    embedded
    vr-mode-ui="enabled:false"
    renderer="colorManagement: true; physicallyCorrectLights: true"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3">

    <a-assets>
      <!-- modele: pune fișierele .glb în folderul models/ -->
      <a-asset-item id="capy" src="models/capybara_low_poly.glb"></a-asset-item>
      <a-asset-item id="watermelon" src="models/watermelon.glb"></a-asset-item>
      <a-asset-item id="slice" src="models/slice_of_watermelon.glb"></a-asset-item>
    </a-assets>

    <!-- LIGHTS -->
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; intensity: 0.6" position="0 1 1"></a-entity>

    <!-- === MARKER: JUNGLE (marker folder: markers/jungle.{fset,fset3,iset}) -->
    <a-nft type="nft" url="markers/jungle" id="marker-jungle">
      <a-entity id="jungle-root" visible="false">
        <!-- capybara (rotating) -->
        <a-entity id="capy-jungle"
                  gltf-model="#capy"
                  scale="0.6 0.6 0.6"
                  position="0 0 0"
                  rotation="0 0 0"
                  visible="false">
        </a-entity>

        <!-- text -->
        <a-entity id="text-jungle"
                  text="value: Oh no… I’m hungry!; align:center; width:2.8; wrapCount:28"
                  position="0 0.9 0"
                  visible="false">
        </a-entity>
      </a-entity>
    </a-nft>

    <!-- === MARKER: DESK/MASA (markers/desk.*) -->
    <a-nft type="nft" url="markers/desk" id="marker-desk">
      <a-entity id="desk-root" visible="false">
        <a-entity id="watermelon-entity"
                  gltf-model="#watermelon"
                  scale="0.45 0.45 0.45"
                  position="0 0 0"
                  rotation="0 0 0"
                  visible="false">
        </a-entity>

        <a-entity id="text-desk"
                  text="value: Wow, this melon looks amazing!; align:center; width:2.8; wrapCount:28"
                  position="0 0.9 0"
                  visible="false">
        </a-entity>
      </a-entity>
    </a-nft>

    <!-- === MARKER: PICNIC (markers/picnic.*) -->
    <a-nft type="nft" url="markers/picnic" id="marker-picnic">
      <a-entity id="picnic-root" visible="false">
        <!-- capybara happy bouncing -->
        <a-entity id="capy-picnic"
                  gltf-model="#capy"
                  scale="0.65 0.65 0.65"
                  position="0 0 0"
                  rotation="0 0 0"
                  visible="false">
        </a-entity>

        <!-- slice of watermelon -->
        <a-entity id="slice-entity"
                  gltf-model="#slice"
                  scale="0.5 0.5 0.5"
                  position="0 -0.15 0.25"
                  rotation="0 90 0"
                  visible="false">
        </a-entity>

        <a-entity id="text-picnic"
                  text="value: Thank you, now I’m happy!; align:center; width:2.8; wrapCount:28"
                  position="0 1.0 0"
                  visible="false">
        </a-entity>
      </a-entity>
    </a-nft>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // State
    let jungleSeen = false;
    let melonSeen  = false;

    // helpers to show/hide
    function showEntity(sel){ const e = document.querySelector(sel); if(e) e.setAttribute('visible', 'true'); }
    function hideEntity(sel){ const e = document.querySelector(sel); if(e) e.setAttribute('visible', 'false'); }

    // Jungle marker handlers
    const mJ = document.getElementById('marker-jungle');
    mJ.addEventListener('markerFound', () => {
      console.log('JUNGLE FOUND');
      jungleSeen = true;
      // show root
      showEntity('#jungle-root');
      // show capy and text
      showEntity('#capy-jungle');
      showEntity('#text-jungle');

      // make capy rotate slowly (loop)
      const capy = document.querySelector('#capy-jungle');
      if (capy) {
        capy.setAttribute('animation__spin', 'property: rotation; to: 0 360 0; loop: true; dur: 6000; easing: linear');
      }
    });
    mJ.addEventListener('markerLost', () => {
      console.log('JUNGLE LOST');
      // keep jungleSeen true (remembers that user scanned it)
      // hide visuals
      hideEntity('#capy-jungle');
      hideEntity('#text-jungle');
      hideEntity('#jungle-root');
    });

    // Desk marker handlers (desk)
    const mD = document.getElementById('marker-desk');
    mD.addEventListener('markerFound', () => {
      console.log('DESK FOUND');
      // Only show watermelon if jungle was seen
      if (!jungleSeen) {
        console.log('Desk found but jungle not seen yet — doing nothing (rule).');
        // Optionally show a short tip to scan jungle first - we will flash a small message briefly
        // (but per rule we don't spawn model)
        return;
      }
      melonSeen = true;
      showEntity('#desk-root');
      showEntity('#watermelon-entity');
      showEntity('#text-desk');

      // slowly rotate the melon for effect
      const melon = document.querySelector('#watermelon-entity');
      if (melon) {
        melon.setAttribute('animation__spin', 'property: rotation; to: 0 360 0; loop: true; dur: 7000; easing: linear');
      }
    });
    mD.addEventListener('markerLost', () => {
      console.log('DESK LOST');
      // keep melonSeen true (remembers)
      hideEntity('#watermelon-entity');
      hideEntity('#text-desk');
      hideEntity('#desk-root');
    });

    // Picnic marker handlers
    const mP = document.getElementById('marker-picnic');
    mP.addEventListener('markerFound', () => {
      console.log('PICNIC FOUND');
      // Only allow final scene if both previous markers were seen
      if (!(jungleSeen && melonSeen)) {
        console.log('Picnic found but prereqs missing — do nothing (rule).');
        return;
      }
      showEntity('#picnic-root');
      showEntity('#capy-picnic');
      showEntity('#slice-entity');
      showEntity('#text-picnic');

      // Make capy bounce (y-position animation)
      const c = document.querySelector('#capy-picnic');
      if (c) {
        c.setAttribute('animation__bounce', 'property: position; dir: alternate; dur: 600; loop: true; to: 0 0.18 0; from: 0 0 0; easing: easeInOutQuad');
      }

      // Option: spin the slice slowly
      const s = document.querySelector('#slice-entity');
      if (s) {
        s.setAttribute('animation__spin', 'property: rotation; to: 0 360 0; loop: true; dur: 9000; easing: linear');
      }
    });
    mP.addEventListener('markerLost', () => {
      console.log('PICNIC LOST');
      hideEntity('#capy-picnic');
      hideEntity('#slice-entity');
      hideEntity('#text-picnic');
      hideEntity('#picnic-root');
    });

    // Small dev helper: press 'r' to reset states (for quick testing)
    window.addEventListener('keydown', (e) => {
      if (e.key === 'r') {
        jungleSeen = false; melonSeen = false;
        console.log('States reset: jungleSeen=false, melonSeen=false');
        // hide everything
        ['#jungle-root','#desk-root','#picnic-root'].forEach(hideEntity);
      }
    });
  </script>
</body>
</html>
