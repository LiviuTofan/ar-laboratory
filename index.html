<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>AR Story - Three Markers</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    #log {
      position: fixed;
      top: 10px;
      left: 10px;
      right: 10px;
      background: rgba(0,0,0,0.9);
      color: lime;
      padding: 15px;
      font-family: monospace;
      font-size: 14px;
      z-index: 9999;
      max-height: 300px;
      overflow-y: auto;
      border: 3px solid lime;
    }
  </style>
</head>
<body>
  <div id="log">Starting...</div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">
    
    <!-- Load 3D Models -->
    <a-assets>
      <a-asset-item id="capy" src="models/capybara_low_poly.glb"></a-asset-item>
      <a-asset-item id="watermelon" src="models/watermelon.glb"></a-asset-item>
      <a-asset-item id="slice" src="models/slice_of_watermelon.glb"></a-asset-item>
    </a-assets>

    <!-- LIGHTS for 3D models -->
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; intensity: 0.6" position="0 1 1"></a-entity>
    
    <!-- JUNGLE MARKER - CAPYBARA -->
    <a-nft
      type="nft"
      url="markers/jungle"
      id="jungle-marker"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <!-- CAPYBARA 3D MODEL -->
      <a-entity position="100 100 -100" rotation="-90 0 0">
        <a-entity 
          gltf-model="#capy"
          scale="60 60 60"
          rotation="0 0 0"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 6000; easing: linear">
        </a-entity>
      </a-entity>
      
      <!-- TEXT -->
      <a-text
        value="Oh no... I'm hungry!"
        align="center"
        color="#ff0000"
        position="100 200 -100"
        scale="50 50 50">
      </a-text>
    </a-nft>

    <!-- DESK MARKER - WATERMELON -->
    <a-nft
      type="nft"
      url="markers/desk"
      id="desk-marker"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <!-- WATERMELON 3D MODEL -->
      <a-entity position="150 200 -300" rotation="-90 0 0" id="desk-model">
        <a-entity 
          gltf-model="#watermelon"
          scale="150 150 150"
          rotation="0 0 0"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 7000; easing: linear">
        </a-entity>
      </a-entity>
      
      <!-- TEXT - SUCCESS -->
      <a-text
        id="desk-text-success"
        value="Wow, this melon looks amazing!"
        align="center"
        color="#00ff00"
        position="150 300 -300"
        scale="50 50 50"
        visible="false">
      </a-text>
      
      <!-- TEXT - BLOCKED -->
      <a-text
        id="desk-text-blocked"
        value="Scan Jungle marker first!"
        align="center"
        color="#ff0000"
        position="0 0 0"
        scale="50 50 50"
        visible="false">
      </a-text>
    </a-nft>

    <!-- PICNIC MARKER - CAPYBARA + WATERMELON SLICE -->
    <a-nft
      type="nft"
      url="markers/picnic"
      id="picnic-marker"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <!-- CAPYBARA WITH BOUNCING -->
      <a-entity 
        id="picnic-capy"
        gltf-model="#capy" 
        position="0 -300 0" 
        scale="30 30 30" 
        rotation="0 90 -90"
        animation="property: position; dir: alternate; dur: 600; loop: true; to: 0 -290 0; from: 0 -300 0; easing: easeInOutQuad"
        visible="false">
      </a-entity>
      
      <!-- WATERMELON SLICE -->
      <a-entity 
        id="picnic-slice"
        gltf-model="#slice" 
        position="50 -300 0" 
        scale="30 30 30" 
        rotation="0 90 -90"
        visible="false">
      </a-entity>
      
      <!-- TEXT - SUCCESS -->
      <a-text
        id="picnic-text-success"
        value="Thank you, now I'm happy!"
        align="center"
        color="#00ffff"
        position="25 -200 0"
        scale="50 50 50"
        visible="false">
      </a-text>
      
      <!-- TEXT - BLOCKED -->
      <a-text
        id="picnic-text-blocked"
        value="Scan Jungle and Desk first!"
        align="center"
        color="#ff0000"
        position="0 0 0"
        scale="50 50 50"
        visible="false">
      </a-text>
    </a-nft>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const logDiv = document.getElementById('log');
    let logs = [];
    
    // SEQUENCE TRACKING: jungle -> desk -> picnic
    let scannedMarkers = {
      jungle: false,
      desk: false,
      picnic: false
    };
    
    function log(msg) {
      console.log(msg);
      const time = new Date().toLocaleTimeString();
      logs.push(`${msg}`);
      if (logs.length > 10) logs.shift();
      logDiv.innerHTML = logs.join('<br>');
    }

    log('Camera starting...');

    setTimeout(() => {
      // JUNGLE (FIRST) - Always visible
      const jungleMarker = document.getElementById('jungle-marker');
      
      if (jungleMarker) {
        jungleMarker.addEventListener('markerFound', () => {
          scannedMarkers.jungle = true;
          log('ðŸŸ¥ Capybara: "Oh no... I\'m hungry!"');
          logDiv.style.borderColor = 'red';
        });
        jungleMarker.addEventListener('markerLost', () => {
          log('Marker lost');
          logDiv.style.borderColor = 'lime';
        });
      }

      // DESK (SECOND - requires jungle)
      const deskMarker = document.getElementById('desk-marker');
      const deskModel = document.getElementById('desk-model');
      
      if (deskMarker) {
        deskMarker.addEventListener('markerFound', () => {
          if (!scannedMarkers.jungle) {
            // BLOCKED
            if (deskModel) deskModel.setAttribute('visible', 'false');
            log('â›” Scan Jungle marker first!');
            logDiv.style.borderColor = 'orange';
            return;
          }
          // SUCCESS
          scannedMarkers.desk = true;
          if (deskModel) deskModel.setAttribute('visible', 'true');
          log('ðŸŸ© Capybara: "Wow, this melon looks amazing!"');
          logDiv.style.borderColor = 'green';
        });
        deskMarker.addEventListener('markerLost', () => {
          if (deskModel) deskModel.setAttribute('visible', 'false');
          log('Marker lost');
          logDiv.style.borderColor = 'lime';
        });
      }

      // PICNIC (THIRD - requires jungle AND desk)
      const picnicMarker = document.getElementById('picnic-marker');
      const picnicCapy = document.getElementById('picnic-capy');
      const picnicSlice = document.getElementById('picnic-slice');
      
      if (picnicMarker) {
        picnicMarker.addEventListener('markerFound', () => {
          if (!scannedMarkers.jungle || !scannedMarkers.desk) {
            // BLOCKED
            if (picnicCapy) picnicCapy.setAttribute('visible', 'false');
            if (picnicSlice) picnicSlice.setAttribute('visible', 'false');
            log('â›” Scan Jungle and Desk markers first!');
            logDiv.style.borderColor = 'orange';
            return;
          }
          // SUCCESS
          scannedMarkers.picnic = true;
          if (picnicCapy) picnicCapy.setAttribute('visible', 'true');
          if (picnicSlice) picnicSlice.setAttribute('visible', 'true');
          log('ðŸŸ¦ Capybara: "Thank you, now I\'m happy!"');
          logDiv.style.borderColor = 'blue';
        });
        picnicMarker.addEventListener('markerLost', () => {
          if (picnicCapy) picnicCapy.setAttribute('visible', 'false');
          if (picnicSlice) picnicSlice.setAttribute('visible', 'false');
          log('Marker lost');
          logDiv.style.borderColor = 'lime';
        });
      }
    }, 2000);
  </script>
</body>
</html>
