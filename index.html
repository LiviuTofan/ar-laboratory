<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>AR Story - Three Markers</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    #log {
      position: fixed;
      top: 10px;
      left: 10px;
      right: 10px;
      background: rgba(0,0,0,0.9);
      color: lime;
      padding: 15px;
      font-family: monospace;
      font-size: 14px;
      z-index: 9999;
      max-height: 300px;
      overflow-y: auto;
      border: 3px solid lime;
    }
    #choice-buttons {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      gap: 20px;
      z-index: 9999;
    }
    .choice-btn {
      padding: 15px 30px;
      font-size: 18px;
      font-weight: bold;
      border: 3px solid white;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    #btn-orange {
      background: orange;
      color: white;
    }
    #btn-orange:hover {
      background: darkorange;
      transform: scale(1.1);
    }
    #btn-watermelon {
      background: #ff1744;
      color: white;
    }
    #btn-watermelon:hover {
      background: #c51162;
      transform: scale(1.1);
    }
  </style>
</head>
<body>
  <div id="log">Starting...</div>
  <div id="choice-buttons">
    <button id="btn-orange" class="choice-btn">üçä Orange</button>
    <button id="btn-watermelon" class="choice-btn">üçâ Watermelon</button>
  </div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">
    
    <!-- Load 3D Models -->
    <a-assets>
      <a-asset-item id="capy" src="models/capybara_low_poly.glb"></a-asset-item>
      <a-asset-item id="watermelon" src="models/watermelon.glb"></a-asset-item>
      <a-asset-item id="slice" src="models/slice_of_watermelon.glb"></a-asset-item>
      <a-asset-item id="orange" src="models/orange.glb"></a-asset-item>
      <a-asset-item id="orange_slice" src="models/orange_slice.glb"></a-asset-item>
    </a-assets>

    <!-- LIGHTS for 3D models -->
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; intensity: 0.6" position="0 1 1"></a-entity>
    
    <!-- JUNGLE MARKER - CAPYBARA -->
    <a-nft
      type="nft"
      url="markers/jungle"
      id="jungle-marker"
      smooth="true"
      smoothCount="5"
      smoothTolerance="0.5"
      smoothThreshold="2">
      
      <!-- CAPYBARA 3D MODEL -->
      <a-entity position="100 100 -100" rotation="-90 0 0">
        <a-entity 
          gltf-model="#capy"
          scale="60 60 60"
          rotation="0 0 0"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 6000; easing: linear">
        </a-entity>
      </a-entity>
      
      <!-- TEXT -->
      <a-text
        value="Oh no... I'm hungry!"
        align="center"
        color="#ff0000"
        position="100 200 -100"
        scale="50 50 50">
      </a-text>
    </a-nft>

    <!-- DESK MARKER - WATERMELON & ORANGE CHOICE -->
    <a-nft
      type="nft"
      url="markers/desk"
      id="desk-marker"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <!-- WATERMELON 3D MODEL (LEFT) -->
      <a-entity position="125 200 -300" rotation="-90 0 0" id="watermelon-choice" class="clickable">
        <a-entity 
          gltf-model="#watermelon"
          scale="150 150 150"
          rotation="0 0 0"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 7000; easing: linear">
        </a-entity>
      </a-entity>
      
      <!-- ORANGE 3D MODEL (RIGHT) -->
      <a-entity position="175 200 -300" rotation="-90 0 0" id="orange-choice" class="clickable">
        <a-entity 
          gltf-model="#orange"
          scale="150 150 150"
          rotation="0 0 0"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 7000; easing: linear">
        </a-entity>
      </a-entity>
      
      <!-- TEXT - CHOICE -->
      <a-text
        id="desk-text-choice"
        value="Ohhh I have to choose from Orange and Watermelon help me!"
        align="center"
        color="#ffff00"
        position="275 300 -300"
        scale="50 50 50"
        visible="false">
      </a-text>
      
      <!-- TEXT - BLOCKED -->
      <a-text
        id="desk-text-blocked"
        value="Scan Jungle marker first!"
        align="center"
        color="#ff0000"
        position="0 0 0"
        scale="50 50 50"
        visible="false">
      </a-text>
    </a-nft>

    <!-- PICNIC MARKER - CAPYBARA + CHOSEN FRUIT SLICE -->
    <a-nft
      type="nft"
      url="markers/picnic"
      id="picnic-marker"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <!-- CAPYBARA WITH BOUNCING -->
      <a-entity 
        id="picnic-capy"
        gltf-model="#capy" 
        position="0 -300 0" 
        scale="30 30 30" 
        rotation="0 90 -90"
        animation="property: position; dir: alternate; dur: 600; loop: true; to: 0 -290 0; from: 0 -300 0; easing: easeInOutQuad"
        visible="false">
      </a-entity>
      
      <!-- WATERMELON SLICE (if chosen) -->
      <a-entity 
        id="picnic-watermelon-slice"
        gltf-model="#slice" 
        position="50 -300 0" 
        scale="30 30 30" 
        rotation="0 90 -90"
        visible="false">
      </a-entity>
      
      <!-- ORANGE SLICE (if chosen) -->
      <a-entity 
        id="picnic-orange-slice"
        gltf-model="#orange_slice" 
        position="50 -300 0" 
        scale="60 60 60" 
        rotation="0 90 -90"
        visible="false">
      </a-entity>
      
      <!-- TEXT - SUCCESS -->
      <a-text
        id="picnic-text-success"
        value="Thank you, now I'm happy!"
        align="center"
        color="#00ffff"
        position="25 -200 0"
        scale="50 50 50"
        visible="false">
      </a-text>
      
      <!-- TEXT - BLOCKED -->
      <a-text
        id="picnic-text-blocked"
        value="Scan Jungle and Desk first!"
        align="center"
        color="#ff0000"
        position="0 0 0"
        scale="50 50 50"
        visible="false">
      </a-text>
    </a-nft>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const logDiv = document.getElementById('log');
    let logs = [];
    
    // SEQUENCE TRACKING: jungle -> desk -> picnic
    let scannedMarkers = {
      jungle: false,
      desk: false,
      picnic: false
    };
    
    // FRUIT CHOICE TRACKING
    let chosenFruit = null; // 'watermelon' or 'orange'
    
    // Get choice buttons
    const choiceButtons = document.getElementById('choice-buttons');
    const btnOrange = document.getElementById('btn-orange');
    const btnWatermelon = document.getElementById('btn-watermelon');
    
    function log(msg) {
      console.log(msg);
      const time = new Date().toLocaleTimeString();
      logs.push(`${msg}`);
      if (logs.length > 10) logs.shift();
      logDiv.innerHTML = logs.join('<br>');
    }

    log('Camera starting...');

    setTimeout(() => {
      // JUNGLE (FIRST) - Always visible
      const jungleMarker = document.getElementById('jungle-marker');
      
      if (jungleMarker) {
        jungleMarker.addEventListener('markerFound', () => {
          scannedMarkers.jungle = true;
          log('üü• Capybara: "Oh no... I\'m hungry!"');
          logDiv.style.borderColor = 'red';
        });
        jungleMarker.addEventListener('markerLost', () => {
          log('Marker lost');
          logDiv.style.borderColor = 'lime';
        });
      }

      // DESK (SECOND - requires jungle) - CHOICE BETWEEN WATERMELON AND ORANGE
      const deskMarker = document.getElementById('desk-marker');
      const watermelonChoice = document.getElementById('watermelon-choice');
      const orangeChoice = document.getElementById('orange-choice');
      const deskTextChoice = document.getElementById('desk-text-choice');
      const deskTextBlocked = document.getElementById('desk-text-blocked');
      
      if (deskMarker) {
        deskMarker.addEventListener('markerFound', () => {
          if (!scannedMarkers.jungle) {
            // BLOCKED
            if (watermelonChoice) watermelonChoice.setAttribute('visible', 'false');
            if (orangeChoice) orangeChoice.setAttribute('visible', 'false');
            if (deskTextChoice) deskTextChoice.setAttribute('visible', 'false');
            if (deskTextBlocked) deskTextBlocked.setAttribute('visible', 'true');
            log('‚õî Scan Jungle marker first!');
            logDiv.style.borderColor = 'orange';
            return;
          }
          // SUCCESS - Show choice
          if (watermelonChoice) watermelonChoice.setAttribute('visible', 'true');
          if (orangeChoice) orangeChoice.setAttribute('visible', 'true');
          if (deskTextChoice) deskTextChoice.setAttribute('visible', 'true');
          if (deskTextBlocked) deskTextBlocked.setAttribute('visible', 'false');
          
          // Show choice buttons
          if (!chosenFruit) {
            choiceButtons.style.display = 'flex';
            log('üü© Capybara: "Ohhh I have to choose from Orange and Watermelon help me!"');
          } else {
            log('üü© You already chose ' + chosenFruit.toUpperCase());
          }
          logDiv.style.borderColor = 'yellow';
        });
        deskMarker.addEventListener('markerLost', () => {
          if (watermelonChoice) watermelonChoice.setAttribute('visible', 'false');
          if (orangeChoice) orangeChoice.setAttribute('visible', 'false');
          if (deskTextChoice) deskTextChoice.setAttribute('visible', 'false');
          if (deskTextBlocked) deskTextBlocked.setAttribute('visible', 'false');
          choiceButtons.style.display = 'none';
          log('Marker lost');
          logDiv.style.borderColor = 'lime';
        });
      }
      
      // BUTTON CLICK HANDLERS FOR FRUIT CHOICE
      if (btnWatermelon) {
        btnWatermelon.addEventListener('click', () => {
          chosenFruit = 'watermelon';
          scannedMarkers.desk = true;
          choiceButtons.style.display = 'none';
          log('‚úÖ You chose WATERMELON! üçâ');
          logDiv.style.borderColor = 'green';
        });
      }
      
      if (btnOrange) {
        btnOrange.addEventListener('click', () => {
          chosenFruit = 'orange';
          scannedMarkers.desk = true;
          choiceButtons.style.display = 'none';
          log('‚úÖ You chose ORANGE! üçä');
          logDiv.style.borderColor = 'orange';
        });
      }

      // PICNIC (THIRD - requires jungle AND desk choice)
      const picnicMarker = document.getElementById('picnic-marker');
      const picnicCapy = document.getElementById('picnic-capy');
      const picnicWatermelonSlice = document.getElementById('picnic-watermelon-slice');
      const picnicOrangeSlice = document.getElementById('picnic-orange-slice');
      const picnicTextSuccess = document.getElementById('picnic-text-success');
      const picnicTextBlocked = document.getElementById('picnic-text-blocked');
      
      if (picnicMarker) {
        picnicMarker.addEventListener('markerFound', () => {
          if (!scannedMarkers.jungle || !scannedMarkers.desk || !chosenFruit) {
            // BLOCKED
            if (picnicCapy) picnicCapy.setAttribute('visible', 'false');
            if (picnicWatermelonSlice) picnicWatermelonSlice.setAttribute('visible', 'false');
            if (picnicOrangeSlice) picnicOrangeSlice.setAttribute('visible', 'false');
            if (picnicTextSuccess) picnicTextSuccess.setAttribute('visible', 'false');
            if (picnicTextBlocked) picnicTextBlocked.setAttribute('visible', 'true');
            log('‚õî Scan Jungle and choose a fruit on Desk first!');
            logDiv.style.borderColor = 'orange';
            return;
          }
          // SUCCESS - Show capybara with chosen fruit
          scannedMarkers.picnic = true;
          if (picnicCapy) picnicCapy.setAttribute('visible', 'true');
          if (picnicTextSuccess) picnicTextSuccess.setAttribute('visible', 'true');
          if (picnicTextBlocked) picnicTextBlocked.setAttribute('visible', 'false');
          
          // IF-ELSE: Show chosen fruit slice
          if (chosenFruit === 'watermelon') {
            if (picnicWatermelonSlice) picnicWatermelonSlice.setAttribute('visible', 'true');
            if (picnicOrangeSlice) picnicOrangeSlice.setAttribute('visible', 'false');
            log('üü¶ Capybara: "Thank you, now I\'m happy!" (with watermelon)');
          } else if (chosenFruit === 'orange') {
            if (picnicOrangeSlice) picnicOrangeSlice.setAttribute('visible', 'true');
            if (picnicWatermelonSlice) picnicWatermelonSlice.setAttribute('visible', 'false');
            log('üü¶ Capybara: "Thank you, now I\'m happy!" (with orange)');
          }
          
          logDiv.style.borderColor = 'blue';
        });
        picnicMarker.addEventListener('markerLost', () => {
          if (picnicCapy) picnicCapy.setAttribute('visible', 'false');
          if (picnicWatermelonSlice) picnicWatermelonSlice.setAttribute('visible', 'false');
          if (picnicOrangeSlice) picnicOrangeSlice.setAttribute('visible', 'false');
          if (picnicTextSuccess) picnicTextSuccess.setAttribute('visible', 'false');
          if (picnicTextBlocked) picnicTextBlocked.setAttribute('visible', 'false');
          log('Marker lost');
          logDiv.style.borderColor = 'lime';
        });
      }
    }, 2000);
  </script>
</body>
</html>
